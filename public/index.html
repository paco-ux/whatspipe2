<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsPipe – Fase 3 (Notion)</title>
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --muted:#8ea0b5; --accent:#4cc38a; --accent-2:#3aa876; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:#e6edf3;margin:0;padding:24px}
    .container{max-width:980px;margin:0 auto}
    h1{font-size:26px;margin:0 0 18px;color:#a5d6ff}
    p.hint{color:var(--muted);margin:4px 0 18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:12px}
    label{font-weight:600;font-size:12px;color:#c7d4e5;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #23314b;background:#0f1726;color:#e6edf3;outline:none}
    select[multiple]{height:108px}
    textarea{min-height:90px;resize:vertical}
    button{padding:11px 14px;border-radius:12px;border:0;background:var(--accent);color:#052014;font-weight:700;cursor:pointer}
    button:hover{background:var(--accent-2)}
    .secondary{background:#23314b;color:#c7d4e5}
    .card{background:var(--card);border:1px solid #23314b;padding:16px;border-radius:14px;margin-bottom:12px}
    .preview{background:#0f1726;border:1px dashed #2a3b5d;padding:12px;border-radius:10px;min-height:70px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 8px;border-radius:999px;background:#223357;color:#bcd1ec;font-size:12px}
    .err{color:#ffd2d2;background:#4c1d1d;border:1px solid #7f1d1d;padding:10px;border-radius:8px;display:none;margin-top:8px}
    .ok{color:#dcffe7;background:#0e4026;border:1px solid #1b6f46;padding:10px;border-radius:8px;display:none;margin-top:8px}
    small{color:#9fb2c9}
    .footer{color:#7f91aa;font-size:12px;margin-top:18px}
  </style>
</head>
<body>
  <div class="container">
    <h1>WhatsPipe — Fase 3 · Plantillas desde Notion</h1>
    <p class="hint">Leemos plantillas reales desde tu DB de Notion (con filtros por <em>Clase</em>, <em>Categoría</em> y <em>Etiquetas</em>). Los secretos viven solo en el servidor.</p>

    <!-- Pipedrive (Fase 2) -->
    <div class="card">
      <div class="grid">
        <div>
          <label for="pipedriveLink">Link o ID de Pipedrive</label>
          <input id="pipedriveLink" placeholder="https://app.pipedrive.com/person/123 o 123" />
        </div>
        <div class="inline" style="align-self:end;justify-content:flex-end;">
          <div class="inline">
            <input id="assumeMX" type="checkbox" style="width:auto"/>
            <label for="assumeMX" style="margin:0">Agregar +52 si falta (México)</label>
          </div>
          <button id="btnLoad">Cargar desde Pipedrive</button>
        </div>
      </div>
      <div id="pdAlerts" class="inline" style="gap:12px;margin-top:8px;">
        <div id="pdErr" class="err"></div>
        <div id="pdOk" class="ok"></div>
      </div>
    </div>

    <!-- Fase 3: filtros y plantillas -->
    <div class="card">
      <div class="grid-3">
        <div>
          <label for="fClase">Clase</label>
          <select id="fClase"><option value="">Todas</option></select>
        </div>
        <div>
          <label for="fCategoria">Categoría</label>
          <select id="fCategoria"><option value="">Todas</option></select>
        </div>
        <div>
          <label for="fEtiquetas">Etiquetas (múltiple)</label>
          <select id="fEtiquetas" multiple></select>
        </div>
      </div>
      <div class="inline" style="margin-top:10px;">
        <button id="btnFetch">Cargar/Actualizar plantillas</button>
        <button id="btnRefreshCats" class="secondary">Actualizar catálogos</button>
      </div>

      <div class="row">
        <div>
          <label for="plantilla">Seleccionar plantilla</label>
          <select id="plantilla">
            <option value="">-- Selecciona una plantilla --</option>
          </select>
        </div>
        <div>
          <label for="mensajeLibre">Mensaje libre (opcional)</label>
          <textarea id="mensajeLibre" placeholder="Escribe desde cero si no quieres usar una plantilla"></textarea>
        </div>
      </div>

      <div class="row">
        <label>Vista previa</label>
        <div id="preview" class="preview">Aquí aparecerá tu mensaje...</div>
      </div>

      <div class="inline">
        <button id="btnPreview">Generar vista previa</button>
        <button class="secondary" id="btnSimulate">Simular envío</button>
      </div>
      <div id="ntErr" class="err"></div>
      <div id="ntOk" class="ok"></div>
      <div class="footer">Envío real a WhatsApp se activa en Fase 6.</div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const show = (el, msg)=>{ el.textContent=msg; el.style.display='block'; };
  const hide = (el)=>{ el.style.display='none'; };

  // ---------- Fase 2 (Pipedrive) ----------
  function parsePipedriveInput(input){
    input = (input||'').trim();
    try{
      if(input.startsWith('http')){
        const u = new URL(input);
        const parts = u.pathname.split('/').filter(Boolean);
        if(parts.length>=2){ return { type: normalizeType(parts[0]), id: parts[1].replace(/\D/g,'') }; }
      }
    }catch(e){}
    if(/^\d+$/.test(input)) return { type:'person', id: input };
    return null;
  }
  const normalizeType = t => ({person:'person',persons:'person',deal:'deal',deals:'deal',organization:'organization',organizations:'organization'}[String(t).toLowerCase()] || 'person');
  const sanitizePhone = (raw, addMX)=>{ if(!raw) return ''; let d=String(raw).replace(/\D/g,''); if(addMX && d.length===10) d='52'+d; return d; };

  async function getPipedriveViaProxy(entity, id){
    const res = await fetch(`/api/pipedrive?entity=${encodeURIComponent(entity)}&id=${encodeURIComponent(id)}`);
    if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
    return res.json();
  }

  $('btnLoad').addEventListener('click', async ()=>{
    hide($('pdErr')); hide($('pdOk'));
    const parsed = parsePipedriveInput($('pipedriveLink').value);
    if(!parsed){ show($('pdErr'),'No pude interpretar el link o ID.'); return; }
    try{
      const r = await getPipedriveViaProxy(parsed.type, parsed.id);
      if(!r.ok) throw new Error(r.error || 'Respuesta no OK');
      const addMX = $('assumeMX').checked;
      $('nombre').value = r.data.name || ''; // backward compat if present in DOM
      $('telefono').value = sanitizePhone(r.data.phone, addMX);
      show($('pdOk'), `Datos cargados (${parsed.type} #${parsed.id})`);
    }catch(e){ show($('pdErr'), 'Error vía proxy: '+(e.message||e)); }
  });

  // ---------- Fase 3 (Notion) ----------
  // Cargar catálogos de Clase/Categoría/Etiquetas
  async function loadCatalogs(){
    hide($('ntErr')); hide($('ntOk'));
    try{
      const r = await (await fetch('/api/notion-tags')).json();
      if(!r.ok) throw new Error(r.error || 'No OK');
      fillSelectOptions($('fClase'), [''], r.clases);
      fillSelectOptions($('fCategoria'), [''], r.categorias);
      fillSelectOptions($('fEtiquetas'), [], r.etiquetas, true);
      show($('ntOk'), 'Catálogos actualizados.');
    }catch(e){ show($('ntErr'), 'Error cargando catálogos: '+(e.message||e)); }
  }

  function fillSelectOptions(sel, prefixList, items, multiple=false){
    const current = new Set([...sel.options].map(o=>o.value));
    sel.innerHTML = '';
    (prefixList||[]).forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent= v===''?'Todas':''+v; sel.appendChild(o);
    });
    (items||[]).forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);
    });
    if(multiple) sel.multiple = true;
  }

  function getSelectedMulti(sel){
    return [...sel.options].filter(o=>o.selected).map(o=>o.value).filter(Boolean);
  }

  async function fetchTemplates(){
    hide($('ntErr')); hide($('ntOk'));
    try{
      const params = new URLSearchParams();
      const clase = $('fClase').value;
      const categoria = $('fCategoria').value;
      const tags = getSelectedMulti($('fEtiquetas'));
      if(clase) params.set('clase', clase);
      if(categoria) params.set('categoria', categoria);
      tags.forEach(t=>params.append('tag', t));
      params.set('limit','300');

      const r = await (await fetch('/api/notion-templates?'+params.toString())).json();
      if(!r.ok) throw new Error(r.error || 'No OK');
      const sel = $('plantilla'); sel.innerHTML = '<option value="">-- Selecciona una plantilla --</option>';
      (r.data||[]).forEach(p=>{
        const o=document.createElement('option');
        o.value = p.mensaje || '';
        o.textContent = p.nombre ? `${p.nombre}${p.clase ? ' — '+p.clase : ''}` : '(sin título)';
        o.dataset.id = p.id;
        o.dataset.clase = p.clase || '';
        o.dataset.categorias = (p.categorias||[]).join(',');
        o.dataset.etiquetas = (p.etiquetas||[]).join(',');
        sel.appendChild(o);
      });
      show($('ntOk'), `Plantillas cargadas: ${r.count}`);
    }catch(e){ show($('ntErr'), 'Error cargando plantillas: '+(e.message||e)); }
  }

  // Reemplazo de variables y vista previa
  function buildMessage(){
    const nombre = (document.getElementById('nombre')||{value:''}).value || '{nombre}';
    const tel = (document.getElementById('telefono')||{value:''}).value || '{telefono}';
    const fromTemplate = $('plantilla').value || '';
    const libre = $('mensajeLibre').value || '';
    let msg = libre ? libre : fromTemplate;
    msg = (msg || '').replaceAll('{nombre}', nombre).replaceAll('{telefono}', tel).replaceAll('{fecha}', 'XX/XX/XXXX');
    return msg || '...';
  }

  $('btnFetch').addEventListener('click', fetchTemplates);
  $('btnRefreshCats').addEventListener('click', loadCatalogs);
  $('btnPreview').addEventListener('click', ()=>{ $('preview').textContent = buildMessage(); });
  $('btnSimulate').addEventListener('click', ()=>{
    const tel = (document.getElementById('telefono')||{value:''}).value.trim();
    const text = buildMessage();
    if(!tel){ show($('ntErr'),'Completa el teléfono.'); return; }
    if(!text || text==='...'){ show($('ntErr'),'Selecciona una plantilla o escribe un mensaje.'); return; }
    hide($('ntErr'));
    alert(`Simulación: wa.me/${tel}?text=${encodeURIComponent(text)}`);
  });

  // Auto: cargar catálogos en el primer render
  loadCatalogs();
</script>
</body>
</html>
