<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsPipe — Fase 2</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0f172a; color: #f1f5f9; padding: 20px; }
    .card { background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: none; }
    label { font-size: 0.9em; }
    button { background: #10b981; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #059669; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .error { background: #b91c1c; color: white; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .preview { background: #334155; padding: 10px; border-radius: 4px; margin-top: 10px; }
  </style>
</head>
<body>

  <h1>WhatsPipe — Fase 2 · Conexión con Pipedrive (Proxy)</h1>
  <p>Usamos un <b>proxy seguro</b> en Netlify Functions. Tu <code>api_token</code> vive como variable de entorno en el servidor.</p>

  <div class="card">
    <label for="pipedriveUrl">Link o ID de Pipedrive</label>
    <input id="pipedriveUrl" placeholder="https://orderly.pipedrive.com/deal/13991"/>
    <label>
      <input type="checkbox" id="addMX" /> Agregar +52 si falta (México)
    </label>
    <div class="grid">
      <button id="loadFromPipedrive">Cargar desde Pipedrive (vía proxy)</button>
      <button id="testProxy">Probar proxy</button>
    </div>
    <div id="pipedriveError" class="error" style="display:none;"></div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label for="nombre">Nombre</label>
        <input id="nombre" placeholder="Ej. Juan Pérez"/>
      </div>
      <div>
        <label for="telefono">Teléfono</label>
        <input id="telefono" placeholder="Ej. 521234567890"/>
      </div>
    </div>
  </div>

  <div class="card">
    <label for="plantilla">Seleccionar plantilla</label>
    <select id="plantilla">
      <option value="">Seguimiento general</option>
    </select>

    <label for="mensajeLibre">Mensaje libre (opcional)</label>
    <textarea id="mensajeLibre" placeholder="Escribe desde cero si no quieres usar una plantilla"></textarea>
  </div>

  <div class="card">
    <h3>Vista previa</h3>
    <div id="preview" class="preview">Aquí aparecerá tu mensaje...</div>
    <div class="grid">
      <button id="generatePreview">Generar vista previa</button>
      <button id="simulateSend">Simular envío (Fase 2)</button>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    async function loadFromPipedrive() {
      const url = $('pipedriveUrl').value.trim();
      const addMX = $('addMX').checked;
      $('pipedriveError').style.display = 'none';

      try {
        const r = await fetch(`/api/pipedrive-proxy?url=${encodeURIComponent(url)}`);
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();

        if ($('nombre')) $('nombre').value = data.name || '';
        if ($('telefono')) $('telefono').value = sanitizePhone(data.phone, addMX);

      } catch (err) {
        $('pipedriveError').innerText = `Error vía proxy: ${err.message}`;
        $('pipedriveError').style.display = 'block';
      }
    }

    function sanitizePhone(phone, addMX) {
      let clean = (phone || '').replace(/\D/g, '');
      if (addMX && !clean.startsWith('52')) clean = '52' + clean;
      return clean;
    }

    function generatePreview() {
      const nombre = $('nombre')?.value || '{nombre}';
      const mensaje = $('mensajeLibre')?.value || '';
      $('preview').innerText = mensaje.replace('{nombre}', nombre);
    }

    $('loadFromPipedrive').addEventListener('click', loadFromPipedrive);
    $('generatePreview').addEventListener('click', generatePreview);
  </script>

</body>
</html>
