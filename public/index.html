<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WhatsPipe ‚Äî MVP</title>
<style>
:root{--bg:#0b1220;--card:#111a2d;--muted:#91a4bd;--br:#263653;--acc:#4cc38a}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:#e6edf3}
.wrap{max-width:1000px;margin:0 auto;padding:20px}
h1{margin:0 0 10px;color:#a5d6ff}
.card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:16px;margin:12px 0}
label{display:block;font-size:12px;color:#c8d6ea;margin:8px 0 6px}
input,select,textarea,button{font:inherit}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;background:#0f1726;color:#e6edf3}
textarea{min-height:140px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.btn{background:var(--acc);color:#032016;font-weight:700;border:0;border-radius:10px;padding:14px;cursor:pointer}
.small{color:var(--muted);font-size:12px}
.err{display:none;background:#4c1d1d;border:1px solid #7f1d1d;color:#ffd2d2;border-radius:8px;padding:10px;margin-top:8px}
.ok{display:none;background:#0e4026;border:1px solid #1b6f46;color:#dcffe7;border-radius:8px;padding:10px;margin-top:8px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.pill{background:#13223a;border:1px solid #2b3e61;border-radius:999px;padding:6px 10px;color:#cfe;cursor:pointer}
.pill[aria-pressed="true"]{outline:2px solid #3f5c8a}
#tplList{margin-top:12px;border:1px solid #2b3e61;border-radius:10px;overflow:auto;max-height:420px}
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{padding:10px;border-bottom:1px solid #21324e}
.tbl th{font-size:12px;color:#a9c4e8;text-align:left;background:#0f1828;position:sticky;top:0}
.tbl tr:hover{background:#0f1726}
.badge{font-size:11px;background:#13223a;border:1px solid #2b3e61;border-radius:999px;padding:2px 8px;color:#cfe;margin-right:6px;display:inline-block}
.star{cursor:pointer;user-select:none;font-size:18px}
.star.on{color:#ffd166}
.star.off{color:#48607f}
#editor{background:#0f1726;border:1px dashed #2b3e61;border-radius:10px}
.link-empty{display:inline-block;margin-top:10px;font-size:13px;color:#a5d6ff;text-decoration:underline;cursor:pointer}
.link-empty:hover{opacity:.9}
.notice{font-size:13px;color:#a5d6ff;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>WhatsPipe ‚Äî MVP</h1>

  <!-- 1) Cargar desde Pipedrive -->
  <div class="card">
    <h3>1) Cargar datos desde Pipedrive</h3>
    <div class="grid2">
      <div>
        <label for="pdurl">Link o ID de Pipedrive</label>
        <input id="pdurl" placeholder="https://empresa.pipedrive.com/deal/12345 o 12345"/>
        <div class="small">Acepta <b>deal/person/organization</b> o solo el n√∫mero (por defecto persona).</div>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="btnPd">Cargar desde Pipedrive</button>
        <div style="margin-top:8px"><label><input type="checkbox" id="addmx" checked/> Agregar +52 si falta (MX)</label></div>
      </div>
    </div>
    <div id="pdOk" class="ok"></div>
    <div id="pdErr" class="err"></div>
  </div>

  <!-- 2) Datos del contacto -->
  <div class="card">
    <h3>2) Datos del contacto</h3>
    <div class="grid2">
      <div>
        <label for="nombre">Nombre</label>
        <input id="nombre" placeholder="Ej. Ana L√≥pez"/>
      </div>
      <div>
        <label for="telefono">Tel√©fono</label>
        <input id="telefono" placeholder="Ej. 5512345678 o 521234567890"/>
        <div class="small">Se sanitiza y, si faltan d√≠gitos de pa√≠s, se a√±ade +52 (opcional).</div>
      </div>
    </div>
  </div>

  <!-- 3) Filtros + acciones -->
  <div class="card">
    <h3>3) Plantillas (desde Notion)</h3>
    <div class="grid3">
      <div>
        <label for="buscador">Buscar por nombre</label>
        <input id="buscador" placeholder="Escribe para filtrar‚Ä¶"/>
      </div>
      <div>
        <label for="clase">Clase</label>
        <select id="clase">
          <option value="">‚Äî Selecciona ‚Äî</option>
        </select>
      </div>
      <div>
        <label for="categoria">Categor√≠a</label>
        <select id="categoria">
          <option value="">‚Äî Selecciona ‚Äî</option>
        </select>
      </div>
    </div>

    <div class="notice" id="needFilters">Selecciona <b>Clase</b> y <b>Categor√≠a</b> para ver plantillas.</div>

    <div class="toolbar">
      <button class="pill" id="btnFavs" aria-pressed="false">‚≠ê Mis favoritas</button>
      <button class="pill" id="btnMasUsadas" aria-pressed="false">üî• M√°s usadas</button>
    </div>

    <div id="tplOk" class="ok"></div>
    <div id="tplErr" class="err"></div>

    <div id="tplList" aria-live="polite">
      <table class="tbl" aria-label="Plantillas">
        <thead>
          <tr>
            <th style="width:32px;"></th>
            <th>Nombre</th>
            <th>Clase/Categor√≠a</th>
            <th>Etiquetas</th>
            <th style="width:90px;">Usos</th>
          </tr>
        </thead>
        <tbody id="tplBody">
          <tr><td colspan="5" class="small" style="padding:14px">Selecciona filtros para empezar‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 4) Editor -->
  <div class="card">
    <h3>4) Mensaje</h3>
    <textarea id="editor" placeholder="Selecciona una plantilla o escribe tu mensaje aqu√≠‚Ä¶"></textarea>
    <div style="margin-top:10px">
      <button class="btn" id="btnEnviar" style="width:100%;">Enviar por WhatsApp</button>
      <div id="lnkVacio" class="link-empty">Enviar mensaje vac√≠o</div>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const state={ all:[], filtered:[], selected:null, onlyFavs:false, orderByUsage:false };
const PDCTX = { person:{}, deal:{}, organization:{}, flat:{} };

// ---------- helpers ----------
function sanitizePhone(raw, addMX=true){
  let d = String(raw||'').replace(/\D/g,'');
  if (!d) return '';
  if (addMX && d.length===10) d = '52'+d;
  return d.replace(/^0+/, '');
}
function getByPath(obj, path){
  try{ return path.split('.').reduce((o,k)=> (o && (k in o)) ? o[k] : undefined, obj) }catch{ return undefined; }
}
const ALIAS = {
  nombre:'nombre', telefono:'telefono', fecha:'fecha',
  empresa:'organization.name', organizacion:'organization.name',
  monto:'deal.value', moneda:'deal.currency', etapa:'deal.stage_name',
  titulo:'deal.title', correo:'person.email'
};
function resolveToken(key, ctx){
  if (ALIAS[key] && ALIAS[key] !== key) key = ALIAS[key];
  if (key==='nombre') return ctx.nombre || '';
  if (key==='telefono') return ctx.telefono || '';
  if (key==='fecha') return new Date().toLocaleDateString();
  const v = getByPath(PDCTX, key);
  return (v!==undefined && v!==null) ? String(v) : undefined;
}
function replacePlaceholders(text, ctx){
  const base = String(text||'');
  return base.replace(/\{([^}]+)\}/g, (_, token)=>{
    const key = token.trim().toLowerCase();
    const val = resolveToken(key, ctx);
    return (val!==undefined) ? val : `{${token}}`;
  });
}

// ---------- Pipedrive ----------
function parsePipedriveInput(input){
  input=(input||'').trim();
  try{
    if (input.startsWith('http')){
      const u = new URL(input);
      const parts = u.pathname.split('/').filter(Boolean);
      if (parts.length>=2){
        const entityMap={deal:'deal',deals:'deal',person:'person',persons:'person',organization:'organization',organizations:'organization'};
        const entity = entityMap[parts[0].toLowerCase()] || 'person';
        const id = parts[1].replace(/\D/g,'');
        if (id) return {entity,id};
      }
    }
  }catch(e){}
  if (/^\d+$/.test(input)) return {entity:'person', id:input};
  return null;
}
$('btnPd').onclick = async ()=>{
  $('pdErr').style.display='none'; $('pdOk').style.display='none';
  const parsed = parsePipedriveInput($('pdurl').value);
  if (!parsed){ $('pdErr').textContent='No pude interpretar el link o ID.'; $('pdErr').style.display='block'; return; }
  try{
    const r = await fetch(`/api/pipedrive?entity=${encodeURIComponent(parsed.entity)}&id=${encodeURIComponent(parsed.id)}`);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Respuesta no OK');

    $('nombre').value = j.data.name || '';
    $('telefono').value = sanitizePhone(j.data.phone, $('addmx').checked);

    PDCTX.person = j.data.person || {};
    PDCTX.deal = j.data.deal || {};
    PDCTX.organization = j.data.organization || {};
    PDCTX.flat = j.data.flat || {};

    $('pdOk').textContent = `Datos cargados (${parsed.entity} #${parsed.id})`;
    $('pdOk').style.display='block';

    if (state.selected) fillEditor(state.selected);
  }catch(e){
    $('pdErr').textContent = 'Error: '+(e.message||e);
    $('pdErr').style.display='block';
  }
};

// ---------- Notion Facets ----------
async function cargarFacets(){
  try{
    const r = await fetch('/api/templates-facets');
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'No OK');

    const sClase=$('clase'), sCat=$('categoria');
    const make = (arr)=>['<option value="">‚Äî Selecciona ‚Äî</option>', ...arr.map(v=>`<option>${v}</option>`)].join('');
    sClase.innerHTML = make(j.data.clases || []);
    sCat.innerHTML = make(j.data.categorias || []);
  }catch(e){
    $('tplErr').textContent = 'No pude cargar las opciones de Clase/Categor√≠a: '+(e.message||e);
    $('tplErr').style.display='block';
  }
}

// ---------- Notion list (filtrado en servidor) ----------
async function cargarPlantillas(){
  const cls = $('clase').value.trim();
  const cat = $('categoria').value.trim();
  if (!cls || !cat){
    $('needFilters').style.display='block';
    const tb = $('tplBody'); tb.innerHTML = `<tr><td colspan="5" class="small" style="padding:14px">Selecciona filtros para empezar‚Ä¶</td></tr>`;
    return;
  }
  $('needFilters').style.display='none';
  try{
    const params = new URLSearchParams({ class: cls, category: cat });
    const q = ($('buscador').value||'').trim();
    if (q) params.set('q', q);
    const r = await fetch('/api/templates-list?'+params.toString());
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'No OK');

    state.all = j.data || [];
    $('tplOk').textContent = `Plantillas cargadas: ${state.all.length}`;
    $('tplOk').style.display='block';
    $('tplErr').style.display='none';
    applyFilters(); // aplica favs/orden si corresponde
  }catch(e){
    $('tplErr').textContent = 'Error cargando plantillas: '+(e.message||e);
    $('tplErr').style.display='block';
    $('tplOk').style.display='none';
  }
}

function applyFilters(){
  const q=($('buscador').value||'').toLowerCase().trim();

  let arr = state.all.filter(t=>{
    if (state.onlyFavs && !t.favorita) return false;
    if (q && !String(t.nombre||'').toLowerCase().includes(q)) return false;
    return true;
  });
  if (state.orderByUsage){
    arr = arr.slice().sort((a,b)=>(b.usos||0)-(a.usos||0));
  }
  state.filtered = arr;
  renderTemplateTable();
}

function renderTemplateTable(){
  const tb = $('tplBody');
  tb.innerHTML = '';
  if (!state.filtered.length){
    tb.innerHTML = `<tr><td colspan="5" class="small" style="padding:14px">No hay resultados con el filtro actual.</td></tr>`;
    return;
  }
  state.filtered.forEach(t=>{
    const tr = document.createElement('tr');

    const tdStar = document.createElement('td');
    const star = document.createElement('span');
    star.className = 'star ' + (t.favorita ? 'on':'off');
    star.textContent = '‚òÖ';
    star.title = t.favorita ? 'Quitar de favoritas':'Marcar como favorita';
    star.onclick = async (ev)=>{
      ev.stopPropagation();
      const nueva = !t.favorita;
      star.className = 'star ' + (nueva?'on':'off');
      try{
        await fetch('/api/templates-favorite', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ pageId: t.id, favorita: nueva })
        });
        t.favorita = nueva;
        if (state.onlyFavs && !nueva) applyFilters();
      }catch(e){}
    };
    tdStar.appendChild(star);
    tr.appendChild(tdStar);

    const tdName = document.createElement('td');
    tdName.textContent = t.nombre || '(Sin nombre)';
    tr.appendChild(tdName);

    const tdCc = document.createElement('td');
    tdCc.textContent = [t.clase||'', t.categoria||''].filter(Boolean).join(' / ');
    tr.appendChild(tdCc);

    const tdTags = document.createElement('td');
    (t.etiquetas||[]).forEach(e=>{
      const b = document.createElement('span');
      b.className='badge'; b.textContent='#'+e;
      tdTags.appendChild(b);
    });
    tr.appendChild(tdTags);

    const tdUsos = document.createElement('td');
    tdUsos.textContent = t.usos || 0;
    tr.appendChild(tdUsos);

    tr.onclick = async ()=>{
      state.selected = t;
      fillEditor(t);
      try{
        const res = await fetch('/api/templates-usage', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ pageId: t.id })
        });
        const js = await res.json();
        if (js?.ok){ t.usos = js.usos; tdUsos.textContent = t.usos; }
      }catch(e){}
      document.getElementById('editor').scrollIntoView({behavior:'smooth', block:'center'});
    };

    tb.appendChild(tr);
  });
}

function fillEditor(tpl){
  const nombre = $('nombre').value || '';
  const telefono = sanitizePhone($('telefono').value, true);
  const base = tpl?.mensaje || '';
  const final = replacePlaceholders(base, {nombre, telefono});
  $('editor').value = final;
}

// Controles UI
$('buscador').addEventListener('input', ()=> {
  // si ya hay filtros activos, recarga desde servidor con q
  const cls=$('clase').value.trim(), cat=$('categoria').value.trim();
  if (cls && cat) cargarPlantillas(); else applyFilters();
});
$('clase').addEventListener('change', cargarPlantillas);
$('categoria').addEventListener('change', cargarPlantillas);
$('btnFavs').addEventListener('click', ()=>{
  state.onlyFavs = !state.onlyFavs;
  $('btnFavs').setAttribute('aria-pressed', String(state.onlyFavs));
  applyFilters();
});
$('btnMasUsadas').addEventListener('click', ()=>{
  state.orderByUsage = !state.orderByUsage;
  $('btnMasUsadas').setAttribute('aria-pressed', String(state.orderByUsage));
  applyFilters();
});

// Enviar con texto del editor
$('btnEnviar').addEventListener('click', async ()=>{
  const tel = sanitizePhone($('telefono').value,true);
  const msg = $('editor').value || '';
  if (!tel){ alert('Completa el tel√©fono'); return; }
  if (!msg){ alert('Escribe o carga un mensaje'); return; }

  if (state.selected){
    try{ await fetch('/api/templates-usage', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pageId: state.selected.id }) }); }catch(e){}
  }

  const url = `https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
});

// Enviar vac√≠o
$('lnkVacio').addEventListener('click', ()=>{
  const tel = sanitizePhone($('telefono').value,true);
  if (!tel){ alert('Completa el tel√©fono'); return; }
  window.open(`https://wa.me/${tel}`, '_blank');
});

// Init
document.addEventListener('DOMContentLoaded', async ()=>{
  await cargarFacets();   // llena selectores
