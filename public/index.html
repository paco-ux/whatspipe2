<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsPipe — Fase 2</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0f172a; color: #f1f5f9; padding: 20px; }
    .card { background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: none; }
    label { font-size: 0.9em; }
    button { background: #10b981; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #059669; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .error { background: #b91c1c; color: white; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .preview { background: #334155; padding: 10px; border-radius: 4px; margin-top: 10px; }
  </style>
</head>
<body>

  <h1>WhatsPipe — Fase 2 · Conexión con Pipedrive (Proxy)</h1>
  <p>Usamos un <b>proxy seguro</b> en Netlify Functions. Tu <code>api_token</code> vive como variable de entorno en el servidor.</p>

  <div class="card">
    <label for="pipedriveUrl">Link o ID de Pipedrive</label>
    <input id="pipedriveUrl" placeholder="https://orderly.pipedrive.com/deal/13991"/>
    <label>
      <input type="checkbox" id="addMX" /> Agregar +52 si falta (México)
    </label>
    <div class="grid">
      <button id="loadFromPipedrive">Cargar desde Pipedrive (vía proxy)</button>
      <button id="testProxy">Probar proxy</button>
    </div>
    <div id="pipedriveError" class="error" style="display:none;"></div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label for="nombre">Nombre</label>
        <input id="nombre" placeholder="Ej. Juan Pérez"/>
      </div>
      <div>
        <label for="telefono">Teléfono</label>
        <input id="telefono" placeholder="Ej. 521234567890"/>
      </div>
    </div>
  </div>

  <div class="card">
    <label for="plantilla">Seleccionar plantilla</label>
    <select id="plantilla">
      <option value="">Seguimiento general</option>
    </select>

    <label for="mensajeLibre">Mensaje libre (opcional)</label>
    <textarea id="mensajeLibre" placeholder="Escribe desde cero si no quieres usar una plantilla"></textarea>
  </div>

  <div class="card">
    <h3>Vista previa</h3>
    <div id="preview" class="preview">Aquí aparecerá tu mensaje...</div>
    <div class="grid">
      <button id="generatePreview">Generar vista previa</button>
      <button id="simulateSend">Simular envío (Fase 2)</button>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    function parsePipedriveInput(input){
      input = (input||'').trim();
      try{
        if(input.startsWith('http')){
          const u = new URL(input);
          const [type, id] = u.pathname.split('/').filter(Boolean);
          if (type && id) return { type: normalize(type), id: id.replace(/\D/g,'') };
        }
      }catch(e){}
      if (/^\d+$/.test(input)) return { type: 'person', id: input };
      return null;
    }

    const normalize = t => ({
      person:'person',persons:'person',
      deal:'deal',deals:'deal',
      organization:'organization',organizations:'organization'
    }[String(t).toLowerCase()] || 'person');

    const sanitizePhone = (raw, addMX) => {
      let d=String(raw||'').replace(/\D/g,'');
      if(addMX && d.length===10) d='52'+d;
      return d;
    };

    async function loadFromPipedrive(){
      const input = $('pipedriveUrl').value;
      const addMX = $('addMX').checked;
      const parsed = parsePipedriveInput(input);
      const err = $('pipedriveError');
      err.style.display = 'none';

      if (!parsed){ 
        err.textContent = 'No pude interpretar el link o ID.'; 
        err.style.display='block'; 
        return; 
      }

      try {
        const res = await fetch(`/api/pipedrive?entity=${encodeURIComponent(parsed.type)}&id=${encodeURIComponent(parsed.id)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const r = await res.json();
        if (!r.ok) throw new Error(r.error || 'Respuesta no OK');

        $('nombre').value = r.data.name || '';
        $('telefono').value = sanitizePhone(r.data.phone, addMX);
      } catch (e){
        err.textContent = `Error vía proxy: ${e.message || e}`;
        err.style.display = 'block';
      }
    }

    function generatePreview() {
      const nombre = $('nombre')?.value || '{nombre}';
      const mensaje = $('mensajeLibre')?.value || 'Hola {nombre}, te escribo para coordinar tu seguimiento.';
      $('preview').innerText = mensaje.replace('{nombre}', nombre);
    }

    $('loadFromPipedrive').addEventListener('click', loadFromPipedrive);
    $('generatePreview').addEventListener('click', generatePreview);
  </script>

</body>
</html>
