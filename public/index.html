<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsPipe - Fase 2 (Proxy Seguro)</title>
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --muted:#8ea0b5; --accent:#4cc38a; --accent-2:#3aa876; --danger:#e5484d; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:#e6edf3;margin:0;padding:24px}
    .container{max-width:820px;margin:0 auto}
    h1{font-size:26px;margin:0 0 18px;color:#a5d6ff}
    p.hint{color:var(--muted);margin:4px 0 18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:12px}
    label{font-weight:600;font-size:12px;color:#c7d4e5;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #23314b;background:#0f1726;color:#e6edf3;outline:none}
    textarea{min-height:90px;resize:vertical}
    button{padding:11px 14px;border-radius:12px;border:0;background:var(--accent);color:#052014;font-weight:700;cursor:pointer}
    button:hover{background:var(--accent-2)}
    .secondary{background:#23314b;color:#c7d4e5}
    .card{background:var(--card);border:1px solid #23314b;padding:16px;border-radius:14px;margin-bottom:12px}
    .preview{background:#0f1726;border:1px dashed #2a3b5d;padding:12px;border-radius:10px;min-height:70px}
    .inline{display:flex;gap:8px;align-items:center}
    .pill{padding:6px 8px;border-radius:999px;background:#223357;color:#bcd1ec;font-size:12px}
    .err{color:#ffd2d2;background:#4c1d1d;border:1px solid #7f1d1d;padding:10px;border-radius:8px;display:none;margin-top:8px}
    .ok{color:#dcffe7;background:#0e4026;border:1px solid #1b6f46;padding:10px;border-radius:8px;display:none;margin-top:8px}
    small{color:#9fb2c9}
    .footer{color:#7f91aa;font-size:12px;margin-top:18px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>WhatsPipe — Fase 2 · Conexión con Pipedrive (Proxy)</h1>
    <p class="hint">Usamos un <strong>proxy seguro</strong> en Netlify Functions. Tu <code>api_token</code> vive como variable de entorno en el servidor. <span class="pill">Nada de tokens en el navegador</span></p>

    <div class="card">
      <div class="grid">
        <div>
          <label for="pipedriveLink">Link o ID de Pipedrive</label>
          <input id="pipedriveLink" placeholder="Ej. https://app.pipedrive.com/person/123 o solo 123" />
        </div>
        <div class="inline" style="align-self:end">
          <input id="assumeMX" type="checkbox" style="width:auto"/>
          <label for="assumeMX" style="margin:0">Agregar +52 si falta (México)</label>
        </div>
      </div>
      <div class="two">
        <button id="btnLoad">Cargar desde Pipedrive (via proxy)</button>
        <button id="btnHealth" class="secondary">Probar proxy</button>
      </div>
      <div id="errorBox" class="err"></div>
      <div id="okBox" class="ok"></div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="nombre">Nombre</label>
          <input id="nombre" placeholder="Ej. Juan Pérez"/>
        </div>
        <div>
          <label for="telefono">Teléfono</label>
          <input id="telefono" placeholder="Ej. 521234567890"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="plantilla">Seleccionar plantilla</label>
          <select id="plantilla">
            <option value="">-- Selecciona una plantilla --</option>
            <option value="Hola {nombre}, te escribo para coordinar tu seguimiento.">Seguimiento general</option>
            <option value="Hola {nombre}, ¿podemos agendar una llamada el {fecha}?">Agendar llamada</option>
          </select>
        </div>
        <div>
          <label for="mensajeLibre">Mensaje libre (opcional)</label>
          <textarea id="mensajeLibre" placeholder="Escribe desde cero si no quieres usar una plantilla"></textarea>
        </div>
      </div>

      <div class="row">
        <label>Vista previa</label>
        <div id="preview" class="preview">Aquí aparecerá tu mensaje...</div>
      </div>

      <div class="inline">
        <button id="btnPreview">Generar vista previa</button>
        <button class="secondary" id="btnSimulate">Simular envío (Fase 2)</button>
      </div>
      <div class="footer">El envío real a WhatsApp se activa en Fase 4.</div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const showErr = (msg)=>{ const el=$('errorBox'); el.textContent=msg; el.style.display='block'; $('okBox').style.display='none'; };
    const showOk  = (msg)=>{ const el=$('okBox'); el.textContent=msg; el.style.display='block'; $('errorBox').style.display='none'; };
    const clearAlerts = ()=>{ $('errorBox').style.display='none'; $('okBox').style.display='none'; };

    function parsePipedriveInput(input){
      input = (input||'').trim();
      if(!input) return null;
      try{
        if(input.startsWith('http')){
          const u = new URL(input);
          const parts = u.pathname.split('/').filter(Boolean);
          if(parts.length>=2){
            const type = parts[0];
            const id = parts[1].replace(/\D/g,'');
            return { type: normalizeType(type), id };
          }
        }
      }catch(e){}
      if(/^\d+$/.test(input)){ return { type:'person', id: input }; }
      return null;
    }
    function normalizeType(t){
      const map = { person:'person', persons:'person', deal:'deal', deals:'deal', organization:'organization', organizations:'organization' };
      return map[t?.toLowerCase()] || 'person';
    }
    function sanitizePhone(raw, addMX){
      if(!raw) return '';
      let digits = (''+raw).replace(/\D/g,'');
      if(addMX && digits.length===10){ digits = '52'+digits; }
      return digits;
    }
    function buildMessage(){
      const nombre = $('nombre').value || '{nombre}';
      const fromTemplate = $('plantilla').value || '';
      const libre = $('mensajeLibre').value || '';
      let msg = libre ? libre : fromTemplate;
      msg = (msg || '').replaceAll('{nombre}', nombre).replaceAll('{fecha}', 'XX/XX/XXXX');
      return msg || '...';
    }

    async function getViaProxy(entity, id){
      const url = `/api/pipedrive?entity=${encodeURIComponent(entity)}&id=${encodeURIComponent(id)}`; 
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
      return res.json();
    }

    $('btnLoad').addEventListener('click', async ()=>{
      clearAlerts();
      const parsed = parsePipedriveInput($('pipedriveLink').value);
      if(!parsed){ showErr('No pude interpretar el link o ID.'); return; }
      try{
        const r = await getViaProxy(parsed.type, parsed.id);
        if(!r.ok) throw new Error(r.error || 'Respuesta no OK');
        const addMX = $('assumeMX').checked;
        $('nombre').value = r.data.name || '';
        $('telefono').value = sanitizePhone(r.data.phone, addMX);
        showOk(`Datos cargados (${parsed.type} #${parsed.id})`);
      }catch(err){
        showErr('Error vía proxy: '+ (err && err.message || err));
      }
    });

    $('btnHealth').addEventListener('click', async ()=>{
      clearAlerts();
      try{
        const res = await fetch('/api/pipedrive?id=0'); 
        showOk('Proxy responde ✔️ (si despliegas con env configurado funcionará con IDs reales)');
      }catch(e){
        showErr('No se pudo contactar el proxy. Asegúrate de desplegar en Netlify.');
      }
    });

    $('btnPreview').addEventListener('click', ()=>{
      $('preview').textContent = buildMessage();
    });

    $('btnSimulate').addEventListener('click', ()=>{
      const tel = $('telefono').value.trim();
      const text = buildMessage();
      if(!tel){ showErr('Completa el teléfono.'); return; }
      if(!text || text==='...'){ showErr('Selecciona una plantilla o escribe un mensaje.'); return; }
      clearAlerts();
      alert(`Simulación (Fase 2): wa.me/${tel}?text=${encodeURIComponent(text)}`);
    });
  </script>
</body>
</html>
